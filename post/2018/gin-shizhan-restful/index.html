<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  
  <title>Gin实战:Gin&#43;Mysql简单的Restful风格API简介</title>
  
  
<link href="//cdn.jsdelivr.net" rel="dns-prefetch">
<link href="//cdnjs.cloudflare.com" rel="dns-prefetch">
<link href="//at.alicdn.com" rel="dns-prefetch">
<link href="//fonts.googleapis.com" rel="dns-prefetch">
<link href="//fonts.gstatic.com" rel="dns-prefetch">    
<link href="//www.google-analytics.com" rel="dns-prefetch">  



<meta name="author" content="人世间">
<meta name="description" content="Gin实战：Gin&#43;Mysql简单的Restful风格的API 我们已经了解了Golang的Gin框架。对于Webservice服务，restful风格几乎一统天下。Gin也天然的支持restful。下"> 


<meta name="generator" content="Hugo 0.54.0">


<link rel="canonical" href="http://www.imxcz.com/post/2018/gin-shizhan-restful/"> 
<meta name="renderer" content="webkit">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="format-detection" content="telephone=no,email=no,adress=no">
<meta http-equiv="Cache-Control" content="no-transform">


<meta name="robots" content="index,follow">
<meta name="referrer" content="origin-when-cross-origin"> 
<meta name="google-site-verification" content="_moDmnnBNVLBN1rzNxyGUGdPHE20YgbmrtzLIbxaWFc"> 
<meta name="msvalidate.01" content="22596E34341DD1D17D6022C44647E587">   


<link rel="icon" href="http://www.imxcz.com/favicon.ico">


<link rel="preload" href="http://www.imxcz.com/styles/main.min.css" as="style"> 
<link href="https://fonts.googleapis.com/css?family=Josefin+Sans" rel="stylesheet">
<link rel="preload" href="http://www.imxcz.com/images/avatar.png" as="image">

<link rel="stylesheet" href="http://www.imxcz.com/styles/main.min.css"> 
<link href="https://fonts.googleapis.com/css?family=Josefin+Sans" rel="stylesheet">



<script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.2/dist/medium-zoom.min.js"></script>




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/video.js@7.3.0/dist/video-js.min.css"> 
  
  
<!--[if lte IE 8]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/videojs-ie8@1.1.2/dist/videojs-ie8.min.js"></script>
<![endif]-->

<!--[if lte IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/eligrey-classlist-js-polyfill@1.2.20180112/classList.min.js"></script>
<![endif]-->


</head>
  <body>
    
    <div class="suspension">
      <a role="button" aria-label="Go to top" title="Go to top" class="to-top is-hide"><span class="icon icon-up" aria-hidden="true"></span></a>
      
        
      
    </div>
    
    
  <header class="site-header">
  <div class="top-header">
  <img class="avatar" src="http://www.imxcz.com/images/avatar.png" alt="Avatar">
  
  <h2 class="title">幸存者IMxcz.Com</h2>
  
  
  <button class="menu-toggle" type="button" aria-label="Main Menu" aria-expanded="false" tab-index="0">
    <span class="icon icon-menu" aria-hidden="true"></span>
  </button>

  <nav class="site-menu collapsed">
    <h2 class="offscreen">Main Menu</h2>
    <ul class="menu-list">
      
      
      
      
        <li class="menu-item
          
          
          
           is-active">
          <a href="http://www.imxcz.com/">Home</a>
        </li>
      
        <li class="menu-item
          
          
          
          ">
          <a href="http://www.imxcz.com/categories/">Categories</a>
        </li>
      
        <li class="menu-item
          
          
          
          ">
          <a href="http://www.imxcz.com/archives/">Archives</a>
        </li>
      
        <li class="menu-item
          
          
          
          ">
          <a href="http://www.imxcz.com/links/">Links</a>
        </li>
      
        <li class="menu-item
          
          
          
          ">
          <a href="http://www.imxcz.com/about/">About</a>
        </li>
      
    </ul>
  </nav>
</div>
  
</header>

  <section class="main post-detail">
    <content class="content">
    <header class="post-header">
      <h1 class="post-title">Gin实战:Gin&#43;Mysql简单的Restful风格API简介</h1>
      <p class="post-meta">@人世间 · 2018/03/01 · 9 分钟 · 
              
              <a href="http://www.imxcz.com/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E7%AB%A0">技术文章</a>
              
          </p>
    </header>
    <article class="post-content">

<h4 id="gin实战-gin-mysql简单的restful风格的api">Gin实战：Gin+Mysql简单的Restful风格的API</h4>

<p>我们已经了解了Golang的Gin框架。对于Webservice服务，restful风格几乎一统天下。Gin也天然的支持restful。下面就使用gin写一个简单的服务，麻雀虽小，五脏俱全。我们先以一个单文件开始，然后再逐步分解模块成包，组织代码。</p>

<h4 id="it-works">It works</h4>

<p>使用Gin的前提是安装，我们需要安装gin和mysql的驱动，具体的安装方式就不在赘述。可以参考<a href="https://www.jianshu.com/p/a31e4ee25305">Golang 微框架Gin简介</a>和<a href="https://www.jianshu.com/p/015aca3e11ae">Golang持久化</a>。</p>

<p>创建一个文件夹用来为项目，新建一个文件main.go：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">☁  newland  tree
.
└── main.go</code></pre></div>
<p>main.go</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
 <span style="color:#e6db74">&#34;gopkg.in/gin-gonic/gin.v1&#34;</span>
 <span style="color:#e6db74">&#34;net/http&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
 <span style="color:#a6e22e">router</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Default</span>()

 <span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">GET</span>(<span style="color:#e6db74">&#34;/&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
  <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">String</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>, <span style="color:#e6db74">&#34;It works&#34;</span>)
 })

 <span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#e6db74">&#34;:8000&#34;</span>)
}</code></pre></div>
<p>编译运行</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">☁  newland  go run main.go
<span style="color:#f92672">[</span>GIN-debug<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>WARNING<span style="color:#f92672">]</span> Running in <span style="color:#e6db74">&#34;debug&#34;</span> mode. Switch to <span style="color:#e6db74">&#34;release&#34;</span> mode in production.
 - using env: export GIN_MODE<span style="color:#f92672">=</span>release
 - using code: gin.SetMode<span style="color:#f92672">(</span>gin.ReleaseMode<span style="color:#f92672">)</span>

<span style="color:#f92672">[</span>GIN-debug<span style="color:#f92672">]</span> GET    /                         --&gt; main.main.func1 <span style="color:#f92672">(</span><span style="color:#ae81ff">3</span> handlers<span style="color:#f92672">)</span>
<span style="color:#f92672">[</span>GIN-debug<span style="color:#f92672">]</span> Listening and serving HTTP on :8000</code></pre></div>
<p>访问 <code>/</code>即可看见我们返回的字串<code>It works</code></p>

<h4 id="数据库">数据库</h4>

<p>安装完毕框架，完成一次请求响应之后。接下来就是安装数据库驱动和初始化数据相关的操作了。首先，我们需要新建数据表。一个及其简单的数据表：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#f92672">`</span>person<span style="color:#f92672">`</span> (
  <span style="color:#f92672">`</span>id<span style="color:#f92672">`</span> <span style="color:#66d9ef">int</span>(<span style="color:#ae81ff">11</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> <span style="color:#66d9ef">AUTO_INCREMENT</span>,
  <span style="color:#f92672">`</span>first_name<span style="color:#f92672">`</span> <span style="color:#66d9ef">varchar</span>(<span style="color:#ae81ff">40</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> <span style="color:#66d9ef">DEFAULT</span> <span style="color:#e6db74">&#39;&#39;</span>,
  <span style="color:#f92672">`</span>last_name<span style="color:#f92672">`</span> <span style="color:#66d9ef">varchar</span>(<span style="color:#ae81ff">40</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> <span style="color:#66d9ef">DEFAULT</span> <span style="color:#e6db74">&#39;&#39;</span>,
  <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span> (<span style="color:#f92672">`</span>id<span style="color:#f92672">`</span>)
) <span style="color:#66d9ef">ENGINE</span><span style="color:#f92672">=</span>InnoDB <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">CHARSET</span><span style="color:#f92672">=</span>utf8;</code></pre></div>
<p>创建数据表之后，初始化数据库连接池：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {

 <span style="color:#a6e22e">db</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sql</span>.<span style="color:#a6e22e">Open</span>(<span style="color:#e6db74">&#34;mysql&#34;</span>, <span style="color:#e6db74">&#34;root:@tcp(127.0.0.1:3306)/test?parseTime=true&#34;</span>)
 <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">Close</span>()
 <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span>{
  <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#a6e22e">err</span>)
 }
 
 
 <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">SetMaxIdleConns</span>(<span style="color:#ae81ff">20</span>)
 <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">SetMaxOpenConns</span>(<span style="color:#ae81ff">20</span>)
 
 <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">Ping</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span>{
  <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#a6e22e">err</span>)
 }

 <span style="color:#a6e22e">router</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Default</span>()
 <span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">GET</span>(<span style="color:#e6db74">&#34;/&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
  <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">String</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>, <span style="color:#e6db74">&#34;It works&#34;</span>)
 })

 <span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#e6db74">&#34;:8000&#34;</span>)
}</code></pre></div>
<p>使用sql.Open方法会创建一个数据库连接池db。这个db不是数据库连接，它是一个连接池，只有当真正数据库通信的时候才创建连接。例如这里的<code>db.Ping</code>的操作。<code>db.SetMaxIdleConns(20)</code>和<code>db.SetMaxOpenConns(20)</code>分别设置数据库的空闲连接和最大打开连接，即向Mysql服务端发出的所有连接的最大数目。</p>

<blockquote>
<p>如果不设置，默认都是0，表示打开的连接没有限制。我在压测的时候，发现会存在大量的TIME_WAIT状态的连接，虽然mysql的连接数没有上升。设置了这两个参数之后，不在存在大量TIME_WAIT状态的连接了。而且qps也没有明显的变化，出于对数据库的保护，最好设置这连个参数。</p>
</blockquote>

<h4 id="curd-增删改查">CURD 增删改查</h4>

<p>Restful的基本就是对资源的curd操作。下面开启我们的第一个api接口，增加一个资源。</p>

<h5 id="增">增</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {

 <span style="color:#f92672">...</span>
 
 <span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">POST</span>(<span style="color:#e6db74">&#34;/person&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
  <span style="color:#a6e22e">firstName</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Request</span>.<span style="color:#a6e22e">FormValue</span>(<span style="color:#e6db74">&#34;first_name&#34;</span>)
  <span style="color:#a6e22e">lastName</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Request</span>.<span style="color:#a6e22e">FormValue</span>(<span style="color:#e6db74">&#34;last_name&#34;</span>)

  <span style="color:#a6e22e">rs</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">Exec</span>(<span style="color:#e6db74">&#34;INSERT INTO person(first_name, last_name) VALUES (?, ?)&#34;</span>, <span style="color:#a6e22e">firstName</span>, <span style="color:#a6e22e">lastName</span>)
  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
   <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#a6e22e">err</span>)
  }

  <span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rs</span>.<span style="color:#a6e22e">LastInsertId</span>()
  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
   <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#a6e22e">err</span>)
  }
  <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;insert person Id {}&#34;</span>, <span style="color:#a6e22e">id</span>)
  <span style="color:#a6e22e">msg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;insert successful %d&#34;</span>, <span style="color:#a6e22e">id</span>)
  <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{
   <span style="color:#e6db74">&#34;msg&#34;</span>: <span style="color:#a6e22e">msg</span>,
  })
 })
 
 <span style="color:#f92672">...</span>
}</code></pre></div>
<p>执行非query操作，使用db的Exec方法，在mysql中使用<code>?</code>做占位符。最后我们把插入后的id返回给客户端。请求得到的结果如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">☁  ~  curl -X POST http://127.0.0.1:8000/person -d <span style="color:#e6db74">&#34;first_name=hello&amp;last_name=world&#34;</span> | python -m json.tool
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
<span style="color:#ae81ff">100</span>    <span style="color:#ae81ff">62</span>  <span style="color:#ae81ff">100</span>    <span style="color:#ae81ff">30</span>  <span style="color:#ae81ff">100</span>    <span style="color:#ae81ff">32</span>   <span style="color:#ae81ff">5054</span>   <span style="color:#ae81ff">5391</span> --:--:-- --:--:-- --:--:--  <span style="color:#ae81ff">6400</span>
<span style="color:#f92672">{</span>
    <span style="color:#e6db74">&#34;msg&#34;</span>: <span style="color:#e6db74">&#34;insert successful 1&#34;</span>
<span style="color:#f92672">}</span></code></pre></div>
<p>下面可以随意增加几条记录。</p>

<h5 id="查">查</h5>

<p><strong>查询列表 Query</strong></p>

<p>上面我们增加了一条记录，下面就获取这个记录，查一般有两个操作，一个是查询列表，其次就是查询具体的某一条记录。两种大同小异。</p>

<p>为了给查询结果绑定到golang的变量或对象，我们需要先定义一个结构来绑定对象。在main函数的上方定义Person结构：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Person</span> <span style="color:#66d9ef">struct</span> {
 <span style="color:#a6e22e">Id</span>        <span style="color:#66d9ef">int</span>    <span style="color:#e6db74">`json:&#34;id&#34; form:&#34;id&#34;`</span>
 <span style="color:#a6e22e">FirstName</span> <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;first_name&#34; form:&#34;first_name&#34;`</span>
 <span style="color:#a6e22e">LastName</span>  <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;last_name&#34; form:&#34;last_name&#34;`</span>
}</code></pre></div>
<p>然后查询我们的数据列表</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"> <span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">GET</span>(<span style="color:#e6db74">&#34;/persons&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
  <span style="color:#a6e22e">rows</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">Query</span>(<span style="color:#e6db74">&#34;SELECT id, first_name, last_name FROM person&#34;</span>)
  <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">rows</span>.<span style="color:#a6e22e">Close</span>()
  
  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
   <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#a6e22e">err</span>)
  }

  <span style="color:#a6e22e">persons</span> <span style="color:#f92672">:=</span> make([]<span style="color:#a6e22e">Person</span>, <span style="color:#ae81ff">0</span>)

  <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">rows</span>.<span style="color:#a6e22e">Next</span>() {
   <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">person</span> <span style="color:#a6e22e">Person</span>
   <span style="color:#a6e22e">rows</span>.<span style="color:#a6e22e">Scan</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">person</span>.<span style="color:#a6e22e">Id</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">person</span>.<span style="color:#a6e22e">FirstName</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">person</span>.<span style="color:#a6e22e">LastName</span>)
   <span style="color:#a6e22e">persons</span> = append(<span style="color:#a6e22e">persons</span>, <span style="color:#a6e22e">person</span>)
  }
  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">rows</span>.<span style="color:#a6e22e">Err</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
   <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#a6e22e">err</span>)
  }

  <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{
   <span style="color:#e6db74">&#34;persons&#34;</span>: <span style="color:#a6e22e">persons</span>,
  })

 })</code></pre></div>
<p>读取mysql的数据需要有一个绑定的过程，db.Query方法返回一个rows对象，这个数据库连接随即也转移到这个对象，因此我们需要定义row.Close操作。然后创建一个<code>[]Person</code>的切片。</p>

<blockquote>
<p>使用make，而不是直接使用<code>var persons []Person</code>的声明方式。还是有所差别的，使用make的方式，当数组切片没有元素的时候，Json会返回<code>[]</code>。如果直接声明，json会返回<code>null</code>。</p>
</blockquote>

<p>接下来就是使用rows对象的Next方法，遍历所查询的数据，一个个绑定到person对象上，最后append到persons切片。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">☁  ~  curl  http://127.0.0.1:8000/persons | python -m json.tool
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
<span style="color:#ae81ff">100</span>   <span style="color:#ae81ff">113</span>  <span style="color:#ae81ff">100</span>   <span style="color:#ae81ff">113</span>    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>   101k      <span style="color:#ae81ff">0</span> --:--:-- --:--:-- --:--:--  110k
<span style="color:#f92672">{</span>
    <span style="color:#e6db74">&#34;persons&#34;</span>: <span style="color:#f92672">[</span>
        <span style="color:#f92672">{</span>
            <span style="color:#e6db74">&#34;first_name&#34;</span>: <span style="color:#e6db74">&#34;hello&#34;</span>,
            <span style="color:#e6db74">&#34;id&#34;</span>: <span style="color:#ae81ff">1</span>,
            <span style="color:#e6db74">&#34;last_name&#34;</span>: <span style="color:#e6db74">&#34;world&#34;</span>
        <span style="color:#f92672">}</span>,
        <span style="color:#f92672">{</span>
            <span style="color:#e6db74">&#34;first_name&#34;</span>: <span style="color:#e6db74">&#34;vanyar&#34;</span>,
            <span style="color:#e6db74">&#34;id&#34;</span>: <span style="color:#ae81ff">2</span>,
            <span style="color:#e6db74">&#34;last_name&#34;</span>: <span style="color:#e6db74">&#34;elves&#34;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">]</span>
<span style="color:#f92672">}</span></code></pre></div>
<h6 id="查询单条记录-queryrow">查询单条记录 QueryRow</h6>

<p>查询列表需要使用迭代rows对象，查询单个记录，就没这么麻烦了。虽然也可以迭代一条记录的结果集。因为查询单个记录的操作实在太常用了，因此golang的database/sql也专门提供了查询方法</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"> <span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">GET</span>(<span style="color:#e6db74">&#34;/person/:id&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
  <span style="color:#a6e22e">id</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Param</span>(<span style="color:#e6db74">&#34;id&#34;</span>)
  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">person</span> <span style="color:#a6e22e">Person</span>
  <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">QueryRow</span>(<span style="color:#e6db74">&#34;SELECT id, first_name, last_name FROM person WHERE id=?&#34;</span>, <span style="color:#a6e22e">id</span>).<span style="color:#a6e22e">Scan</span>(
   <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">person</span>.<span style="color:#a6e22e">Id</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">person</span>.<span style="color:#a6e22e">FirstName</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">person</span>.<span style="color:#a6e22e">LastName</span>,
  )
  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
   <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
   <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{
    <span style="color:#e6db74">&#34;person&#34;</span>: <span style="color:#66d9ef">nil</span>,
   })
   <span style="color:#66d9ef">return</span>
  }

  <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{
   <span style="color:#e6db74">&#34;person&#34;</span>: <span style="color:#a6e22e">person</span>,
  })

 })</code></pre></div>
<p>查询结果为：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">☁  ~  curl  http://127.0.0.1:8000/person/1 | python -m json.tool
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
<span style="color:#ae81ff">100</span>    <span style="color:#ae81ff">60</span>  <span style="color:#ae81ff">100</span>    <span style="color:#ae81ff">60</span>    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">20826</span>      <span style="color:#ae81ff">0</span> --:--:-- --:--:-- --:--:-- <span style="color:#ae81ff">30000</span>
<span style="color:#f92672">{</span>
    <span style="color:#e6db74">&#34;person&#34;</span>: <span style="color:#f92672">{</span>
        <span style="color:#e6db74">&#34;first_name&#34;</span>: <span style="color:#e6db74">&#34;hello&#34;</span>,
        <span style="color:#e6db74">&#34;id&#34;</span>: <span style="color:#ae81ff">1</span>,
        <span style="color:#e6db74">&#34;first_name&#34;</span>: <span style="color:#e6db74">&#34;world&#34;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span></code></pre></div>
<p>查询单个记录有一个小问题，当数据不存在的时候，同样也会抛出一个错误。粗暴的使用log退出有点不妥。返回一个nil的时候，万一真的是因为错误，比如sql错误。这种情况如何解决。还需要具体场景设计程序。</p>

<h5 id="改">改</h5>

<p>增删改查，下面进行更新的操作。前面增加记录我们使用了urlencode的方式提交，更新的api我们自动匹配绑定content-type</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"> <span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">PUT</span>(<span style="color:#e6db74">&#34;/person/:id&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
  <span style="color:#a6e22e">cid</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Param</span>(<span style="color:#e6db74">&#34;id&#34;</span>)
  <span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Atoi</span>(<span style="color:#a6e22e">cid</span>)
  <span style="color:#a6e22e">person</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Person</span>{<span style="color:#a6e22e">Id</span>: <span style="color:#a6e22e">id</span>}
  <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Bind</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">person</span>)
  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
   <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#a6e22e">err</span>)
  }

  <span style="color:#a6e22e">stmt</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">Prepare</span>(<span style="color:#e6db74">&#34;UPDATE person SET first_name=?, last_name=? WHERE id=?&#34;</span>)
  <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">stmt</span>.<span style="color:#a6e22e">Close</span>()
  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
   <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#a6e22e">err</span>)
  }
  <span style="color:#a6e22e">rs</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">stmt</span>.<span style="color:#a6e22e">Exec</span>(<span style="color:#a6e22e">person</span>.<span style="color:#a6e22e">FirstName</span>, <span style="color:#a6e22e">person</span>.<span style="color:#a6e22e">LastName</span>, <span style="color:#a6e22e">person</span>.<span style="color:#a6e22e">Id</span>)
  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
   <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#a6e22e">err</span>)
  }
  <span style="color:#a6e22e">ra</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rs</span>.<span style="color:#a6e22e">RowsAffected</span>()
  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
   <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#a6e22e">err</span>)
  }
  <span style="color:#a6e22e">msg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;Update person %d successful %d&#34;</span>, <span style="color:#a6e22e">person</span>.<span style="color:#a6e22e">Id</span>, <span style="color:#a6e22e">ra</span>)
  <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{
   <span style="color:#e6db74">&#34;msg&#34;</span>: <span style="color:#a6e22e">msg</span>,
  })
 })</code></pre></div>
<p>使用 urlencode的方式更新：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">☁  ~  curl -X PUT http://127.0.0.1:8000/person/2 -d <span style="color:#e6db74">&#34;first_name=noldor&amp;last_name=elves&#34;</span> | python -m json.tool
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
<span style="color:#ae81ff">100</span>    <span style="color:#ae81ff">72</span>  <span style="color:#ae81ff">100</span>    <span style="color:#ae81ff">39</span>  <span style="color:#ae81ff">100</span>    <span style="color:#ae81ff">33</span>   <span style="color:#ae81ff">3921</span>   <span style="color:#ae81ff">3317</span> --:--:-- --:--:-- --:--:--  <span style="color:#ae81ff">4333</span>
<span style="color:#f92672">{</span>
    <span style="color:#e6db74">&#34;msg&#34;</span>: <span style="color:#e6db74">&#34;Update person 2 successful 1&#34;</span>
<span style="color:#f92672">}</span></code></pre></div>
<p>使用json的方式更新：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">☁  ~  curl -X PUT http://127.0.0.1:8000/person/2 -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span>  -d <span style="color:#e6db74">&#39;{&#34;first_name&#34;: &#34;vanyar&#34;, &#34;last_name&#34;: &#34;elves&#34;}&#39;</span> | python -m json.tool
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
<span style="color:#ae81ff">100</span>    <span style="color:#ae81ff">85</span>  <span style="color:#ae81ff">100</span>    <span style="color:#ae81ff">39</span>  <span style="color:#ae81ff">100</span>    <span style="color:#ae81ff">46</span>   <span style="color:#ae81ff">4306</span>   <span style="color:#ae81ff">5079</span> --:--:-- --:--:-- --:--:--  <span style="color:#ae81ff">5750</span>
<span style="color:#f92672">{</span>
    <span style="color:#e6db74">&#34;msg&#34;</span>: <span style="color:#e6db74">&#34;Update person 2 successful 1&#34;</span>
<span style="color:#f92672">}</span></code></pre></div>
<h5 id="删">删</h5>

<p>最后一个操作就是删除了，删除所需要的功能特性，上面的例子都覆盖了。实现删除也就特别简单了：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"> <span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">DELETE</span>(<span style="color:#e6db74">&#34;/person/:id&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
  <span style="color:#a6e22e">cid</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Param</span>(<span style="color:#e6db74">&#34;id&#34;</span>)
  <span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Atoi</span>(<span style="color:#a6e22e">cid</span>)
  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
   <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#a6e22e">err</span>)
  }
  <span style="color:#a6e22e">rs</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">Exec</span>(<span style="color:#e6db74">&#34;DELETE FROM person WHERE id=?&#34;</span>, <span style="color:#a6e22e">id</span>)
  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
   <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#a6e22e">err</span>)
  }
  <span style="color:#a6e22e">ra</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rs</span>.<span style="color:#a6e22e">RowsAffected</span>()
  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
   <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#a6e22e">err</span>)
  }
  <span style="color:#a6e22e">msg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;Delete person %d successful %d&#34;</span>, <span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">ra</span>)
  <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{
   <span style="color:#e6db74">&#34;msg&#34;</span>: <span style="color:#a6e22e">msg</span>,
  })
 })</code></pre></div>
<p>我们可以使用删除接口，把数据都删除了，再来验证上面post接口获取列表的时候，当记录没有的时候，切片被json序列化<code>[]</code>还是<code>null</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">☁  ~  curl  http://127.0.0.1:8000/persons | python -m json.tool
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
<span style="color:#ae81ff">100</span>    <span style="color:#ae81ff">15</span>  <span style="color:#ae81ff">100</span>    <span style="color:#ae81ff">15</span>    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">11363</span>      <span style="color:#ae81ff">0</span> --:--:-- --:--:-- --:--:-- <span style="color:#ae81ff">15000</span>
<span style="color:#f92672">{</span>
    <span style="color:#e6db74">&#34;persons&#34;</span>: <span style="color:#f92672">[]</span>
<span style="color:#f92672">}</span></code></pre></div>
<p>把<code>persons := make([]Person, 0)</code>改成<code>persons []Person</code>。编译运行：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">☁  ~  curl  http://127.0.0.1:8000/persons | python -m json.tool
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
<span style="color:#ae81ff">100</span>    <span style="color:#ae81ff">17</span>  <span style="color:#ae81ff">100</span>    <span style="color:#ae81ff">17</span>    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">13086</span>      <span style="color:#ae81ff">0</span> --:--:-- --:--:-- --:--:-- <span style="color:#ae81ff">17000</span>
<span style="color:#f92672">{</span>
    <span style="color:#e6db74">&#34;persons&#34;</span>: null
<span style="color:#f92672">}</span></code></pre></div>
<p>至此，基本的CURD操作的restful风格的API已经完成。内容其实不复杂，甚至相当简单。完整的代码可以通过<a href="https://link.jianshu.com?t=https://gist.github.com/rsj217/26492af115a083876570f003c64df118#file-golang-gin-mysql-restful-gp">GIST</a>获取。</p>

<h4 id="组织代码">组织代码</h4>

<p>实现了一个基本点restful服务，可惜我们的代码都在一个文件中。对于一个库，单文件或许很好，对于稍微大一点的项目，单文件总是有点非主流。当然，更多原因是为了程序的可读和维护，我们也需要重新组织代码，拆分模块和包。</p>

<h4 id="封装模型方法">封装模型方法</h4>

<p>我们的handler出来函数中，对请求的出来和数据库的交互，都糅合在一起。首先我们基于创建的Person结构创建数据模型，以及模型的方法。把数据库交互拆分出来。</p>

<p>创建一个单例的数据库连接池对象：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">db</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sql</span>.<span style="color:#a6e22e">DB</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
 <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>
 <span style="color:#a6e22e">db</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">sql</span>.<span style="color:#a6e22e">Open</span>(<span style="color:#e6db74">&#34;mysql&#34;</span>, <span style="color:#e6db74">&#34;root:@tcp(127.0.0.1:3306)/test?parseTime=true&#34;</span>)
 <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
  <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#a6e22e">err</span>)
 }

 <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">Close</span>()

 <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">Ping</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
  <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#a6e22e">err</span>)
 }
 <span style="color:#f92672">...</span>
}</code></pre></div>
<p>这样在main包中，db就能随意使用了。</p>

<p>接下来，再把增加记录的的函数封装成Person结构的方法：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Person</span>) <span style="color:#a6e22e">AddPerson</span>() (<span style="color:#a6e22e">id</span> <span style="color:#66d9ef">int64</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
 <span style="color:#a6e22e">rs</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">Exec</span>(<span style="color:#e6db74">&#34;INSERTs INTO person(first_name, last_name) VALUES (?, ?)&#34;</span>, <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">FirstName</span>, <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">LastName</span>)
 <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
  <span style="color:#66d9ef">return</span>
 }
 <span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">rs</span>.<span style="color:#a6e22e">LastInsertId</span>()
 <span style="color:#66d9ef">return</span>
}</code></pre></div>
<p>然后handler函数也跟着修改，先创建一个Person结构的实例，然后调用其方法即可：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"> <span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">POST</span>(<span style="color:#e6db74">&#34;/person&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
  <span style="color:#a6e22e">firstName</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Request</span>.<span style="color:#a6e22e">FormValue</span>(<span style="color:#e6db74">&#34;first_name&#34;</span>)
  <span style="color:#a6e22e">lastName</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Request</span>.<span style="color:#a6e22e">FormValue</span>(<span style="color:#e6db74">&#34;last_name&#34;</span>)

  <span style="color:#a6e22e">person</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Person</span>{<span style="color:#a6e22e">FirstName</span>: <span style="color:#a6e22e">firstName</span>, <span style="color:#a6e22e">LastName</span>: <span style="color:#a6e22e">lastName</span>}

  <span style="color:#a6e22e">ra_rows</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">person</span>.<span style="color:#a6e22e">AddPerson</span>()
  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
   <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#a6e22e">err</span>)
  }
  <span style="color:#a6e22e">msg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;insert successful %d&#34;</span>, <span style="color:#a6e22e">ra_rows</span>)
  <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{
   <span style="color:#e6db74">&#34;msg&#34;</span>: <span style="color:#a6e22e">msg</span>,
  })
 })</code></pre></div>
<p>对于获取列表的模型方法和handler函数也很好改：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Person</span>) <span style="color:#a6e22e">GetPersons</span>() (<span style="color:#a6e22e">persons</span> []<span style="color:#a6e22e">Person</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
 <span style="color:#a6e22e">persons</span> = make([]<span style="color:#a6e22e">Person</span>, <span style="color:#ae81ff">0</span>)
 <span style="color:#a6e22e">rows</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">Query</span>(<span style="color:#e6db74">&#34;SELECT id, first_name, last_name FROM person&#34;</span>)
 <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">rows</span>.<span style="color:#a6e22e">Close</span>()

 <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
  <span style="color:#66d9ef">return</span>
 }

 <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">rows</span>.<span style="color:#a6e22e">Next</span>() {
  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">person</span> <span style="color:#a6e22e">Person</span>
  <span style="color:#a6e22e">rows</span>.<span style="color:#a6e22e">Scan</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">person</span>.<span style="color:#a6e22e">Id</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">person</span>.<span style="color:#a6e22e">FirstName</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">person</span>.<span style="color:#a6e22e">LastName</span>)
  <span style="color:#a6e22e">persons</span> = append(<span style="color:#a6e22e">persons</span>, <span style="color:#a6e22e">person</span>)
 }
 <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">rows</span>.<span style="color:#a6e22e">Err</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
  <span style="color:#66d9ef">return</span>
 }
 <span style="color:#66d9ef">return</span>
}</code></pre></div>
<p>和</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"> <span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">POST</span>(<span style="color:#e6db74">&#34;/person&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
  <span style="color:#a6e22e">firstName</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Request</span>.<span style="color:#a6e22e">FormValue</span>(<span style="color:#e6db74">&#34;first_name&#34;</span>)
  <span style="color:#a6e22e">lastName</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Request</span>.<span style="color:#a6e22e">FormValue</span>(<span style="color:#e6db74">&#34;last_name&#34;</span>)

  <span style="color:#a6e22e">person</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Person</span>{<span style="color:#a6e22e">FirstName</span>: <span style="color:#a6e22e">firstName</span>, <span style="color:#a6e22e">LastName</span>: <span style="color:#a6e22e">lastName</span>}

  <span style="color:#a6e22e">ra_rows</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">person</span>.<span style="color:#a6e22e">AddPerson</span>()
  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
   <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#a6e22e">err</span>)
  }
  <span style="color:#a6e22e">msg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;insert successful %d&#34;</span>, <span style="color:#a6e22e">ra_rows</span>)
  <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{
   <span style="color:#e6db74">&#34;msg&#34;</span>: <span style="color:#a6e22e">msg</span>,
  })
 })</code></pre></div>
<p>剩下的函数和方法就不再一一举例了。</p>

<blockquote>
<p>增加记录的接口中，我们使用了客户端参数和Person创建实例，然后再调用其方法。而获取列表的接口中，我们直接声明了Person对象。两种方式都可以。</p>
</blockquote>

<h4 id="handler函数">Handler函数</h4>

<p>gin提供了<code>router.Get(url, handler func)</code>的格式。首先我们可以把所有的handler函数从router中提取出来。</p>

<p>例如把增加记录和获取列表的handle提取出来</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">AddPersonApi</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
 <span style="color:#a6e22e">firstName</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Request</span>.<span style="color:#a6e22e">FormValue</span>(<span style="color:#e6db74">&#34;first_name&#34;</span>)
 <span style="color:#a6e22e">lastName</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Request</span>.<span style="color:#a6e22e">FormValue</span>(<span style="color:#e6db74">&#34;last_name&#34;</span>)

 <span style="color:#a6e22e">person</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Person</span>{<span style="color:#a6e22e">FirstName</span>: <span style="color:#a6e22e">firstName</span>, <span style="color:#a6e22e">LastName</span>: <span style="color:#a6e22e">lastName</span>}

 <span style="color:#a6e22e">ra_rows</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">person</span>.<span style="color:#a6e22e">AddPerson</span>()
 <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
  <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#a6e22e">err</span>)
 }
 <span style="color:#a6e22e">msg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;insert successful %d&#34;</span>, <span style="color:#a6e22e">ra_rows</span>)
 <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{
  <span style="color:#e6db74">&#34;msg&#34;</span>: <span style="color:#a6e22e">msg</span>,
 })
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>(){
 <span style="color:#f92672">...</span>
 <span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">POST</span>(<span style="color:#e6db74">&#34;/person&#34;</span>, <span style="color:#a6e22e">AddPersonApi</span>)
 <span style="color:#f92672">...</span> 
}</code></pre></div>
<p>把modle和handler抽出来之后，我们的代码结构变得更加清晰，具体可以参考这个<a href="https://link.jianshu.com?t=https://gist.github.com/rsj217/26492af115a083876570f003c64df118#file-golang-gin-mysql-restful-1-go">GIST</a></p>

<h3 id="组织项目">组织项目</h3>

<p>经过上面的model和handler的分离，代码结构变得更加清晰，可是我们还是单文件。下一步将进行封装不同的包。</p>

<h4 id="数据库处理">数据库处理</h4>

<p>在项目根目录创建下面三个文件夹，<code>apis</code>，<code>databases</code>和<code>models</code>，并在文件夹内创建文件。此时我们的目录结果如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">☁  newland  tree
.
├── apis
│   └── person.go
├── database
│   └── mysql.go
├── main.go
├── models
│   └── person.go
└── router.go</code></pre></div>
<p>apis文件夹存放我们的handler函数，models文件夹用来存放我们的数据模型。</p>

<p>myql.go的包代码如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">database</span>

<span style="color:#f92672">import</span> (
 <span style="color:#e6db74">&#34;database/sql&#34;</span>
 <span style="color:#a6e22e">_</span> <span style="color:#e6db74">&#34;github.com/go-sql-driver/mysql&#34;</span>
 <span style="color:#e6db74">&#34;log&#34;</span>
)

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">SqlDB</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sql</span>.<span style="color:#a6e22e">DB</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">init</span>() {
 <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>
 <span style="color:#a6e22e">SqlDB</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">sql</span>.<span style="color:#a6e22e">Open</span>(<span style="color:#e6db74">&#34;mysql&#34;</span>, <span style="color:#e6db74">&#34;root:@tcp(127.0.0.1:3306)/test?parseTime=true&#34;</span>)
 <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
  <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
 }
 <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">SqlDB</span>.<span style="color:#a6e22e">Ping</span>()
 <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
  <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
 }
}</code></pre></div>
<p>因为我们需要在别的地方使用SqlDB这个变量，因此依照golang的习惯，变量名必须大写开头。</p>

<h4 id="数据model封装">数据model封装</h4>

<p>修改models文件夹下的person.go，把对应的Person结构及其方法移到这里：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">models</span>

<span style="color:#f92672">import</span> (
 <span style="color:#e6db74">&#34;log&#34;</span>
 <span style="color:#a6e22e">db</span> <span style="color:#e6db74">&#34;newland/database&#34;</span>
)

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Person</span> <span style="color:#66d9ef">struct</span> {
 <span style="color:#a6e22e">Id</span>        <span style="color:#66d9ef">int</span>    <span style="color:#e6db74">`json:&#34;id&#34; form:&#34;id&#34;`</span>
 <span style="color:#a6e22e">FirstName</span> <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;first_name&#34; form:&#34;first_name&#34;`</span>
 <span style="color:#a6e22e">LastName</span>  <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;last_name&#34; form:&#34;last_name&#34;`</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Person</span>) <span style="color:#a6e22e">AddPerson</span>() (<span style="color:#a6e22e">id</span> <span style="color:#66d9ef">int64</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
 <span style="color:#a6e22e">rs</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">SqlDB</span>.<span style="color:#a6e22e">Exec</span>(<span style="color:#e6db74">&#34;INSERT INTO person(first_name, last_name) VALUES (?, ?)&#34;</span>, <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">FirstName</span>, <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">LastName</span>)
 <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
  <span style="color:#66d9ef">return</span>
 }
 <span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">rs</span>.<span style="color:#a6e22e">LastInsertId</span>()
 <span style="color:#66d9ef">return</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Person</span>) <span style="color:#a6e22e">GetPersons</span>() (<span style="color:#a6e22e">persons</span> []<span style="color:#a6e22e">Person</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
 <span style="color:#a6e22e">persons</span> = make([]<span style="color:#a6e22e">Person</span>, <span style="color:#ae81ff">0</span>)
 <span style="color:#a6e22e">rows</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">SqlDB</span>.<span style="color:#a6e22e">Query</span>(<span style="color:#e6db74">&#34;SELECT id, first_name, last_name FROM person&#34;</span>)
 <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">rows</span>.<span style="color:#a6e22e">Close</span>()

 <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
  <span style="color:#66d9ef">return</span>
 }

 <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">rows</span>.<span style="color:#a6e22e">Next</span>() {
  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">person</span> <span style="color:#a6e22e">Person</span>
  <span style="color:#a6e22e">rows</span>.<span style="color:#a6e22e">Scan</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">person</span>.<span style="color:#a6e22e">Id</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">person</span>.<span style="color:#a6e22e">FirstName</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">person</span>.<span style="color:#a6e22e">LastName</span>)
  <span style="color:#a6e22e">persons</span> = append(<span style="color:#a6e22e">persons</span>, <span style="color:#a6e22e">person</span>)
 }
 <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">rows</span>.<span style="color:#a6e22e">Err</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
  <span style="color:#66d9ef">return</span>
 }
 <span style="color:#66d9ef">return</span>
}

<span style="color:#f92672">...</span>.</code></pre></div>
<h4 id="handler">handler</h4>

<p>然后把具体的handler函数封装到api包中，因为handler函数要操作数据库，所以会引用model包</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">apis</span>

<span style="color:#f92672">import</span> (
 <span style="color:#e6db74">&#34;net/http&#34;</span>
 <span style="color:#e6db74">&#34;log&#34;</span>
 <span style="color:#e6db74">&#34;fmt&#34;</span>
 <span style="color:#e6db74">&#34;strconv&#34;</span>
 <span style="color:#e6db74">&#34;gopkg.in/gin-gonic/gin.v1&#34;</span>
 . <span style="color:#e6db74">&#34;newland/models&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">IndexApi</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
 <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">String</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>, <span style="color:#e6db74">&#34;It works&#34;</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">AddPersonApi</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
 <span style="color:#a6e22e">firstName</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Request</span>.<span style="color:#a6e22e">FormValue</span>(<span style="color:#e6db74">&#34;first_name&#34;</span>)
 <span style="color:#a6e22e">lastName</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Request</span>.<span style="color:#a6e22e">FormValue</span>(<span style="color:#e6db74">&#34;last_name&#34;</span>)

 <span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Person</span>{<span style="color:#a6e22e">FirstName</span>: <span style="color:#a6e22e">firstName</span>, <span style="color:#a6e22e">LastName</span>: <span style="color:#a6e22e">lastName</span>}

 <span style="color:#a6e22e">ra</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">AddPerson</span>()
 <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
  <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#a6e22e">err</span>)
 }
 <span style="color:#a6e22e">msg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;insert successful %d&#34;</span>, <span style="color:#a6e22e">ra</span>)
 <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{
  <span style="color:#e6db74">&#34;msg&#34;</span>: <span style="color:#a6e22e">msg</span>,
 })
}

<span style="color:#f92672">...</span></code></pre></div>
<h4 id="路由">路由</h4>

<p>最后就是把路由抽离出来，修改router.go，我们在路由文件中封装路由函数</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
 <span style="color:#e6db74">&#34;gopkg.in/gin-gonic/gin.v1&#34;</span>
 . <span style="color:#e6db74">&#34;newland/apis&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">initRouter</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Engine</span> {
 <span style="color:#a6e22e">router</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Default</span>()

 <span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">GET</span>(<span style="color:#e6db74">&#34;/&#34;</span>, <span style="color:#a6e22e">IndexApi</span>)

 <span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">POST</span>(<span style="color:#e6db74">&#34;/person&#34;</span>, <span style="color:#a6e22e">AddPersonApi</span>)

 <span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">GET</span>(<span style="color:#e6db74">&#34;/persons&#34;</span>, <span style="color:#a6e22e">GetPersonsApi</span>)

 <span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">GET</span>(<span style="color:#e6db74">&#34;/person/:id&#34;</span>, <span style="color:#a6e22e">GetPersonApi</span>)

 <span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">PUT</span>(<span style="color:#e6db74">&#34;/person/:id&#34;</span>, <span style="color:#a6e22e">ModPersonApi</span>)

 <span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">DELETE</span>(<span style="color:#e6db74">&#34;/person/:id&#34;</span>, <span style="color:#a6e22e">DelPersonApi</span>)

 <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">router</span>
}</code></pre></div>
<h4 id="app入口">app入口</h4>

<p>最后就是main函数的app入口，将路由导入，同时我们要在main函数结束的时候，关闭全局的数据库连接池：</p>

<p>main.go</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
 <span style="color:#a6e22e">db</span> <span style="color:#e6db74">&#34;newland/database&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
 <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">SqlDB</span>.<span style="color:#a6e22e">Close</span>()
 <span style="color:#a6e22e">router</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">initRouter</span>()
 <span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#e6db74">&#34;:8000&#34;</span>)
}</code></pre></div>
<p>至此，我们就把简单程序进行了更好的组织。当然，golang的程序组织依包为基础，不拘泥，根据具体的应用场景可以组织。</p>

<blockquote>
<p>此时运行项目，不能像之前简单的使用<code>go run main.go</code>，因为包main包含main.go和router.go的文件，因此需要运行<code>go run *.go</code>命令编译运行。如果是最终编译二进制项目，则运行<code>go build -o app</code></p>
</blockquote>

<h3 id="总结">总结</h3>

<p>通过上述的实践，我们了解了Gin框架创建基本的的restful服务。并且了解了如何组织golang的代码包。我们讨论了很多内容，但是唯独缺少测试。测试很重要，考察一个框架或者三方包的时候，是否有测试文件以及测试覆盖率是一个重要的参考。因为测试的内容很多，我们这里就不做单独的测试介绍。后面会结合gofight给gin的api增加测试代码。</p>

<p>此外，更多的内容，可以阅读别人优秀的开源项目，学习并实践，以提升自己的编码能力。</p>

<p>转自：<a href="https://www.jianshu.com/p/a3f63b5da74c">https://www.jianshu.com/p/a3f63b5da74c</a></p>
</article>
    <footer class="post-footer">
      
      <ul class="post-tags">
        
          <li><a href="http://www.imxcz.com/tags/gin"><span class="tag">Gin</span></a></li>
        
          <li><a href="http://www.imxcz.com/tags/golang"><span class="tag">Golang</span></a></li>
        
      </ul>
      
      <p class="post-copyright">
        Link:<a rel='license' href='http://www.imxcz.com/post/2018/gin-shizhan-restful/'>http://www.imxcz.com/post/2018/gin-shizhan-restful/ </a><br>
          © 本文采用 <a rel='license' href='http://creativecommons.org/licenses/by-nc/4.0/' target=''>知识共享署名-非商业性使用 4.0 国际许可协议</a> 进行许可。文章发表于 <strong>381</strong> 天前, 文章内容可能不准确，请酌情参考。
      </p>
      <div class="post-nav">
           
          
          <a href="http://www.imxcz.com/post/2018/golang-jiaochabianyi/" class="next" rel="next" title="Golang在Mac、linux、windows系统下交叉编译">Golang在Mac、linux、windows系统下交叉编译&nbsp; → </a>
          
      </div>
    </footer>
    
      
    
    </content>
    <sidebar>
        <div class="sidebar">
    <section class="widget-box">
        <h3 class="widget-title">分类</h3>
        <ul class="widget-categories">
            
            <li>
                <a href="http://www.imxcz.com/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E7%AB%A0/">技术文章(18)</a>
            </li>
            
            <li>
                <a href="http://www.imxcz.com/categories/%E6%91%84%E5%BD%B1/">摄影(1)</a>
            </li>
            
            <li>
                <a href="http://www.imxcz.com/categories/%E6%98%8E%E6%98%9F%E5%81%B6%E5%83%8F/">明星偶像(1)</a>
            </li>
            
            <li>
                <a href="http://www.imxcz.com/categories/%E7%A7%91%E6%8A%80%E8%B5%84%E8%AE%AF/">科技资讯(1)</a>
            </li>
            
            <li>
                <a href="http://www.imxcz.com/categories/%E8%89%BA%E6%9C%AF%E8%AE%BE%E8%AE%A1/">艺术设计(1)</a>
            </li>
            
            <li>
                <a href="http://www.imxcz.com/categories/%E8%AE%B0%E5%BD%95/">记录(2)</a>
            </li>
            
            <li>
                <a href="http://www.imxcz.com/categories/%E8%B6%A3%E9%97%BB/">趣闻(4)</a>
            </li>
            
            <li>
                <a href="http://www.imxcz.com/categories/%E8%BD%AF%E4%BB%B6%E5%88%86%E4%BA%AB/">软件分享(3)</a>
            </li>
            
        </ul>
    </section>
    <section class="widget-box">
        <h3 class="widget-title">标签</h3>
        <div class="tagcloud">
            
            <a href="http://www.imxcz.com/tags/apache/">apache</a>
            
            <a href="http://www.imxcz.com/tags/centos/">centos</a>
            
            <a href="http://www.imxcz.com/tags/css/">css</a>
            
            <a href="http://www.imxcz.com/tags/curl/">curl</a>
            
            <a href="http://www.imxcz.com/tags/ecshop/">ecshop</a>
            
            <a href="http://www.imxcz.com/tags/ftp/">ftp</a>
            
            <a href="http://www.imxcz.com/tags/gin/">gin</a>
            
            <a href="http://www.imxcz.com/tags/git/">git</a>
            
            <a href="http://www.imxcz.com/tags/golang/">golang</a>
            
            <a href="http://www.imxcz.com/tags/google/">google</a>
            
            <a href="http://www.imxcz.com/tags/htaccess/">htaccess</a>
            
            <a href="http://www.imxcz.com/tags/iis/">iis</a>
            
            <a href="http://www.imxcz.com/tags/jquery/">jquery</a>
            
            <a href="http://www.imxcz.com/tags/mac/">mac</a>
            
            <a href="http://www.imxcz.com/tags/msysgit/">msysgit</a>
            
            <a href="http://www.imxcz.com/tags/mysql/">mysql</a>
            
            <a href="http://www.imxcz.com/tags/php/">php</a>
            
            <a href="http://www.imxcz.com/tags/tortoisegit/">tortoisegit</a>
            
            <a href="http://www.imxcz.com/tags/vsftp/">vsftp</a>
            
            <a href="http://www.imxcz.com/tags/wordpress/">wordpress</a>
            
            <a href="http://www.imxcz.com/tags/%E4%BA%A7%E5%93%81%E7%BB%8F%E7%90%86/">产品经理</a>
            
            <a href="http://www.imxcz.com/tags/%E4%BB%A3%E7%90%86/">代理</a>
            
            <a href="http://www.imxcz.com/tags/%E5%8A%A0%E9%80%9F%E5%99%A8/">加速器</a>
            
            <a href="http://www.imxcz.com/tags/%E5%9B%BE%E7%89%87/">图片</a>
            
            <a href="http://www.imxcz.com/tags/%E5%9E%82%E7%9B%B4%E5%B1%85%E4%B8%AD/">垂直居中</a>
            
            <a href="http://www.imxcz.com/tags/%E5%9F%9F%E5%90%8D/">域名</a>
            
            <a href="http://www.imxcz.com/tags/%E5%A5%B3%E7%A5%9E/">女神</a>
            
            <a href="http://www.imxcz.com/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/">小程序</a>
            
            <a href="http://www.imxcz.com/tags/%E5%B9%BD%E9%BB%98/">幽默</a>
            
            <a href="http://www.imxcz.com/tags/%E6%8B%8D%E7%85%A7/">拍照</a>
            
            <a href="http://www.imxcz.com/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/">正则表达式</a>
            
            <a href="http://www.imxcz.com/tags/%E7%94%A8%E6%88%B7%E4%BD%93%E9%AA%8C/">用户体验</a>
            
            <a href="http://www.imxcz.com/tags/%E7%95%8C%E9%9D%A2%E8%AE%BE%E8%AE%A1/">界面设计</a>
            
            <a href="http://www.imxcz.com/tags/%E7%A0%81%E5%86%9C/">码农</a>
            
            <a href="http://www.imxcz.com/tags/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a>
            
            <a href="http://www.imxcz.com/tags/%E7%BD%91%E6%98%93uu/">网易uu</a>
            
            <a href="http://www.imxcz.com/tags/%E8%87%AA%E5%AE%9A%E4%B9%89/">自定义</a>
            
            <a href="http://www.imxcz.com/tags/%E8%BF%94%E5%9B%9E%E9%A1%B6%E9%83%A8/">返回顶部</a>
            
            <a href="http://www.imxcz.com/tags/%E9%AA%8C%E8%AF%81%E7%A0%81/">验证码</a>
            
            <a href="http://www.imxcz.com/tags/%E9%AB%98%E5%9C%86%E5%9C%86/">高圆圆</a>
            
        </div>
    </section>
    
    <section class="widget-box">
        <h3 class="widget-title">友情链接</h3>
        <ul class="widget-links">
            
            <li>
                <a target="_blank" href="https://www.simianti.cn" title="实验室一站式服务平台">四面体科技</a>
            </li>
            
        </ul>
    </section>
    
    <section class="widget-box">
            <h3 class="widget-title">其他</h3>
            <ul class="widget-links">
                    <li><a href="http://www.imxcz.com/index.xml">文章 RSS</a></li>
                </ul>
        </section>
</div>
      </sidebar>
  </section>
  


<footer class="site-footer">
  <p>© 2012-2019 幸存者IMxcz.Com</p>
  <p>Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> with theme <a href="http://www.imxcz.com" target="_blank" rel="noopener">Imxcz</a>.</p>
  
    <p><a href="http://www.miitbeian.gov.cn" title="Check ICP info" target="_blank" rel="noopener">豫ICP备16005986号-2</a></p>
  
</footer>


<script src="https://cdn.jsdelivr.net/npm/smooth-scroll@15.0.0/dist/smooth-scroll.min.js"></script>



<script async src="https://cdn.jsdelivr.net/npm/video.js@7.3.0/dist/video.min.js"></script>




<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      displayMath: [['$$','$$'], ['\\[','\\]']],
      processEscapes: true,
      processEnvironments: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
      TeX: { equationNumbers: { autoNumber: "AMS" },
      extensions: ["AMSmath.js", "AMSsymbols.js"] }
    },
  });
</script>
<script type="text/x-mathjax-config">
  // Fix <code> tags after MathJax finishes running. This is a
  // hack to overcome a shortcoming of Markdown. Discussion at
  // https://github.com/mojombo/jekyll/issues/199
  MathJax.Hub.Queue(() => {
    MathJax.Hub.getAllJax().map(v => v.SourceElement().parentNode.className += ' has-jax');
  });
</script>



<script src="http://www.imxcz.com/scripts/index.min.js"></script>

<script>
  
  
  
  
  
</script>




<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-XXXXXXXX-X', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







  </body>
</html>
